{% load dynamic_access %}
<div class="flex flex-col gap-4 items-stretch">
  <!-- Chart container -->
  <!-- Landscape mobile will take full height of screen -->
  <div class="relative h-[50vh] max-md:landscape:h-[100vh]">
    <canvas id="main-{{ chart_id }}" width="800"></canvas>
  </div>
  <!-- Date select box -->
  <select id="date-select-{{ chart_id }}" class="select w-full mb-4">
    <option disabled>Pick a date</option>
    {% for date in scrape_dates %}
      <option value="{{ date|date:'Y-m-d' }}"
              {% if forloop.first %}selected{% endif %}>{{ date|date:"F j, Y" }}</option>
    {% endfor %}
  </select>
</div>
<!-- Embed scrape_dates and city_comparison_data securely -->
{% with "scrape-dates-"|add:chart_id as scrape_id %}{{ scrape_dates|json_script:scrape_id }}{% endwith %}
{% with "comparison-data-"|add:chart_id as comp_id %}{{ city_comparison_data|json_script:comp_id }}{% endwith %}
{% with "selected-cities-"|add:chart_id as city_id %}{{ selected_cities|json_script:city_id }}{% endwith %}
<script type="text/javascript">
  // Load data from safely encoded JSON script tags
  const scrapeDates{{ chart_id }} = JSON.parse(document.getElementById('scrape-dates-{{ chart_id }}').textContent);
  const rawData{{ chart_id }} = JSON.parse(document.getElementById('comparison-data-{{ chart_id }}').textContent);
  const cityNames{{ chart_id }} = JSON.parse(document.getElementById('selected-cities-{{ chart_id }}').textContent);

  // Group data by date for quick lookup
  const dataByDate{{ chart_id }} = {};
  rawData{{ chart_id }}.forEach(item => {
    const date = item.scraped_date;
    if (!dataByDate{{ chart_id }}[date]) {
      dataByDate{{ chart_id }}[date] = {
        offerTypes: [],
        city1Prices: [],
        city2Prices: []
      };
    }
    dataByDate{{ chart_id }}[date].offerTypes.push(item.offer_type);
    dataByDate{{ chart_id }}[date].city1Prices.push(item['{{ col1 }}'] ?? null);
    dataByDate{{ chart_id }}[date].city2Prices.push(item['{{ col2 }}'] ?? null);
  });

  var ctx_{{ chart_id }} = document.getElementById('main-{{ chart_id }}').getContext('2d');
  var chart_{{ chart_id }};

  function updateChart{{ chart_id }}(selectedDate) {
    const rootStyles = getComputedStyle(document.documentElement);
    const baseContentColor = rootStyles.getPropertyValue('--color-base-content').trim();
    const baseColor300 = rootStyles.getPropertyValue('--color-base-300').trim();
    const formattedDate = new Date(selectedDate).toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });

    const d = dataByDate{{ chart_id }}[selectedDate];

    if (!d) {
      if (chart_{{ chart_id }}) {
        chart_{{ chart_id }}.destroy();
      } 
      chart_{{ chart_id }} = new Chart(ctx_{{ chart_id }}, {
        type: 'bar',
        data: { labels: [], datasets: [] },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: 'No data available for ' + selectedDate,
            }
          }
        }
      });
      return;
    }

    const config = {
      type: 'bar',
      data: {
        labels: d.offerTypes,
        datasets: [
          {
            label: cityNames{{ chart_id }}[0],
            backgroundColor: 'oklch(0.7445 0.1647 49.04 / 0.85)',
            data: d.city1Prices
          },
          {
            label: cityNames{{ chart_id }}[1],
            backgroundColor: 'oklch(0.6324 0.3379 306 / 84.71%)',
            data: d.city2Prices
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: "{{ title }} " + '(' + formattedDate + ')',
            color: baseContentColor
          },
          tooltip: {
            mode: 'index',
            intersect: false,
            titleColor: baseContentColor,
            bodyColor: baseContentColor,
            footerColor: baseContentColor,
            backgroundColor: baseColor300,
          },
          legend: {
            position: 'top',
            labels: {
              color: baseContentColor
            }
          }
        },
        scales: {
          x: {
            ticks: { color: baseContentColor },
            title: {
              display: true,
              text: 'Offer Type',
              color: baseContentColor
            },
            grid: { color: 'oklch(0.4891 0 0 / 0.2)' }
          },
          y: {
            ticks: { color: baseContentColor },
            title: {
              display: true,
              text: 'Average Price',
              color: baseContentColor
            },
            grid: { color: 'oklch(0.4891 0 0 / 0.2)' }
          }
        }
      }
    };

    if (chart_{{ chart_id }}) {
      chart_{{ chart_id }}.destroy();
    }
    chart_{{ chart_id }} = new Chart(ctx_{{ chart_id }}, config);
  }

  // On page load
  var selectElement = document.getElementById('date-select-{{ chart_id }}');
  updateChart{{ chart_id }}(selectElement.value);

  // On change
  selectElement.addEventListener('change', function () {
    updateChart{{ chart_id }}(this.value);
  });

  function updateChart{{ chart_id }}ThemeChangeCallback() {
    updateChart{{ chart_id }}(selectElement.value);
  }

  document.addEventListener('alpine:init', () => {
    Alpine.store('chartsChangeThemeCallbackList').push(updateChart{{ chart_id }}ThemeChangeCallback);
  });

  document.addEventListener('touchend', function (event) {
    if (event.target && event.target.tagName.toLowerCase() !== "canvas") {
      chart_{{ chart_id }}?.canvas.dispatchEvent(new Event('mouseout'));
    }
  });
</script>
