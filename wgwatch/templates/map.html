{% extends "base.html" %}
{% block content %}
  {% with "listings-with-locations" as listings_loc %}
    {{ listings_with_locations|json_script:listings_loc }}
  {% endwith %}
  {% with "city-center-location" as city_center %}{{ city_center_location|json_script:city_center }}{% endwith %}
  {% with "price-quantiles" as price_quantiles %}{{ listing_price_quantiles|json_script:price_quantiles }}{% endwith %}
  <div id="city-form-wrapper">
    <form method="get" class="w-full">
      <div class="mb-4 p-4 bg-base-200 rounded-lg shadow-sm">
        <p class="text-center">
          This map shows the locations of rental offers in the selected city. Please select a city and offer type below.
        </p>
      </div>
      <select id="citySelection"
              name="citySelection"
              class="select w-full my-4"
              required>
        <option value="" disabled selected>Select a city</option>
        {% for city in cities %}
          <option value="{{ city }}" {% if city == selected_city %}selected{% endif %}>{{ city }}</option>
        {% endfor %}
      </select>
      <select id="offerSelection"
              name="offerSelection"
              class="select w-full"
              required>
        <option value="" disabled selected>Select an offer type</option>
        {% for offer_type in offer_types %}
          <option value="{{ offer_type }}"
                  {% if offer_type == selected_offer_type %}selected{% endif %}>{{ offer_type }}</option>
        {% endfor %}
      </select>
      <button type="submit" class="btn btn-soft btn-primary w-full my-4">Submit</button>
    </form>
  </div>
  {% if selected_city is not None and selected_offer_type is not None %}
    <div id="map" class="h-140"></div>
    <script>
  const cityCenterLocation = JSON.parse(document.getElementById('city-center-location').textContent);
  const quantiles = JSON.parse(document.getElementById('price-quantiles').textContent);
  const listingsData = JSON.parse(document.getElementById('listings-with-locations').textContent);

  var map = L.map('map').setView([cityCenterLocation.lat, cityCenterLocation.lon], cityCenterLocation.zoom);

  L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
    className: 'map-tiles'
  }).addTo(map);

  // Extract sorted quantile values (ascending)
  const quantileValues = Object.values(quantiles).sort((a,b) => a-b);

  // Helper: interpolate color between green and red (green = cheap, red = expensive)
  // t is normalized [0,1], returns a hex color string
  function interpolateColor(t) {
    const r = Math.round(0 + t * (255 - 0));   // 0->255
    const g = Math.round(128 - t * 128);       // 128->0
    const b = 0;
    return `rgb(${r},${g},${b})`;
  }

  // Determine the quantile position for a price
  // Returns a value t in [0,1] based on where price falls in quantile intervals
  function getColorPosition(price) {
    if (price <= quantileValues[0]) return 0;      // cheapest
    if (price >= quantileValues[quantileValues.length -1]) return 1; // most expensive

    for (let i=0; i < quantileValues.length - 1; i++) {
      const lower = quantileValues[i];
      const upper = quantileValues[i+1];
      if (price >= lower && price < upper) {
        // Normalize between lower and upper quantile
        return (i + (price - lower) / (upper - lower)) / (quantileValues.length - 1);
      }
    }
    return 1; // fallback
  }

  listingsData.data.forEach(listing => {
    if (listing.latitude && listing.longitude && listing.price != null) {
      const t = getColorPosition(listing.price);
      const color = interpolateColor(t);

      // Use circle marker with color fill
      L.circleMarker([listing.latitude, listing.longitude], {
        radius: 8,
        fillColor: color,
        color: '#000',
        weight: 1,
        opacity: 1,
        fillOpacity: 0.8
      }).addTo(map).bindPopup(`
        <strong>${listing.name}</strong><br>
        Price: ${listing.price}€<br>
        Square meters: ${listing.square_meters}m²
      `);
    }
  });
    </script>
  {% endif %}
{% endblock content %}
